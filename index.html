<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Macro Generator - Shaman King RPG</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    <style>
        *{box-sizing: border-box;}
        html,body{font-size: 18px; width: 100%; max-width: 1200px; font-family: arial; margin: 10px auto;}
        input, textarea{padding: 10px 15px; display: block; margin-top: 5px; width: 100%; font-weight: bold;}
        input{font-size: 16px;}
        label{display: block; width: 100%; font-size: 16px;}
        label:not(:last-child){
            margin-bottom: 10px;
        }
        textarea{resize: none; height: 150px;}
        small{
            margin-top: 10px;
            display: block;
        }
        h1{text-align: center; font-size: 20px;}
        .d-flex{display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; align-items: start;}
        .d-flex label:not(:only-child){width: calc(100% - 90px);}
        .d-nowrap{flex-wrap: nowrap;}
        .skill-box{padding: 10px;margin-bottom: 10px;border: solid 1px #ccc;}
        .skill-cost{background: #000; color: #fff; padding: 5px; display: block; width: 70px; text-align: center;}
        .skill-options{display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;}
        .skill-options:last-child{margin-bottom: 0;}
        .skill-options label{margin-bottom: 0; width: 100% !important;}
        .skill-options button{padding: 0; border: none; background: transparent; cursor: pointer; position: relative; font-size: 18px;}
        .skill-options button span{position: absolute; background: rgba(255,255,255,0.8); font-weight: bold; padding: 2px; top: -2px; z-index: 1; right: -2px; color: red;}
        .skill-container{display: flex; gap: 20px;}
        .skill-col:first-child{width: 40%;}
        .skill-col:last-child{width: 60%;}
        .skill-imgs{display: flex; gap: 10px; flex-wrap: wrap; margin-top: -20px;}
        .skill-imgs label{margin-bottom: 0; width: 100% !important;}
        .skill-imgs-action{position: relative;}
        .skill-imgs-action:hover button{display: block;}
        .skill-imgs-action button{position: absolute; opacity: 0; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; cursor: pointer;}
        .skill-imgs-action span{position: absolute; background: rgba(255,255,255,0.8); font-weight: bold; padding: 2px; top: -2px; z-index: 1; right: -2px; color: red;}
    </style>
</head>
<body>
    <h1>Gerador de Macro v2.0 - Shaman King RPG</h1>
    <div class="skill">
        <div class="skill-container">
            <div class="skill-col">
                <div class="d-flex skill-box">
                    <label>
                        Nome do Personagem
                        <input type="text" class="skill-char">
                        <small>Observação: Deve ser exatamente igual ao nome do token</small>
                    </label>
                </div>
                <div class="d-flex skill-box">
                    <label>
                        Nome da Habilidade
                        <input type="text" class="skill-name">
                    </label>
                    <div class="skill-info">
                        <label>Custo</label>
                        <span class="skill-cost">0 PO</span>
                    </div>
                    <div class="skill-imgs">
                        <label>Ações</label>
                    </div>
                </div>
                <div class="d-flex skill-box">
                    <label>
                        GIF da Habilidade
                        <input type="text" class="skill-image">
                        <small>Observação: Deve ser um link de imagem</small>
                    </label>
                </div>

                <div class="skill-box">
                    <label>
                        Macro Roll20
                        <textarea class="skill-macro"></textarea>
                    </label>
                </div>
            </div>
            <div class="skill-col">
                <div class="skill-box d-flex d-nowrap">
                    <div class="skill-options medium">
                        <label>Caminho do Médium</label>
                    </div>
                </div>
                <div class="skill-box d-flex d-nowrap">
                    <div class="skill-options ancestral">
                        <label>Caminho dos Primitivos</label>
                    </div>
                </div>
                <div class="skill-box d-flex d-nowrap">
                    <div class="skill-options elemento">
                        <label>Caminho dos Elementos</label>
                    </div>
                </div>
                <div class="skill-box d-flex d-nowrap">
                    <div class="skill-options materia">
                        <label>Caminho da Matéria</label>
                    </div>
                </div>
                <div class="skill-box d-flex d-nowrap">
                    <div class="skill-options sacerdote">
                        <label>Caminho do Sacerdote</label>
                    </div>
                </div>
                <div class="skill-box d-flex d-nowrap">
                    <div class="skill-options proibido">
                        <label>Caminho das Artes Proibidas</label>
                    </div>
                </div>
                <div class="skill-box d-flex d-nowrap">
                    <div class="skill-options divindade">
                        <label>Caminho da Divindade</label>
                    </div>
                </div>
                                <!--
                <div class="skill-box">
                    <div class="skill-options xama_1">
                        <label>Xamã Nv.1</label>
                    </div>
                    <div class="skill-options xama_2">
                        <label>Xamã Nv.2</label>
                    </div>
                    <div class="skill-options xama_3">
                        <label>Xamã Nv.3</label>
                    </div>
                </div>
                <div class="skill-box">
                    <div class="skill-options sacerdote_1">
                        <label>Sacerdote Nv.1</label>
                    </div>
                    <div class="skill-options sacerdote_2">
                        <label>Sacerdote Nv.2</label>
                    </div>
                    <div class="skill-options sacerdote_3">
                        <label>Sacerdote Nv.3</label>
                    </div>
                </div>
                -->
            </div>
        </div>

    </div>

    <script>
        const classes = {
            medium: ['movimentar', 'ataque', 'defesa', 'curar', 'dadoataque', 'dadodefesa', 'dadocurar', 'empurrar', 'puxar', 'acrobacia', 'reagir'],
            ancestral: ['urso','cobra','lobo','aguia','touro','escorpiao','tartaruga'],
            elemento: ['agua','vento','terra','fogo','gelo','madeira','raio'],
            materia: ['gravidade','trocar','extender','tempo','magnetismo','portal','retroceder'],
            sacerdote: ['transferir','energia','converter','recuperar','regenerar','meditar','barreira'],
            proibido: ['corpo','resistencia','dano','area','proteger','combinar','reintegrar'],
            divindade: ['liberar','restringir','voar','corrente','expandir','cegar','defletir']
            /*
            elemento: ['fogo','raio','vento'],
            xama_3: ['puxar','voar','arma','transferir','defletir','grandeespirito'],
            sacerdote: ['meditar'],
            sacerdote_2: ['cosmico','barreira','invocar','expandir'],
            sacerdote_3: ['puxar','voar','restauracao','superior','reintegrar','converter']
            */
        };

        const actions = {
            movimentar: [1, "{{(Movimentar - Ação)Usado apenas em si mesmo. Movimente [[@{char|tmv}]] casas}}"],
            ataque: [1, "{{(Atacar - Ação) Causa [[@{char|tat}]] de dano}}"],
            dadoataque: [1, "{{(Atacar DA - Ação) Causa [[@{char|da}]] de dano}}"],
            defesa: [1, "{{(Defender - Ação) Usado apenas em si mesmo. Concede [[@{char|tdf}]] de armadura.}}"],
            dadodefesa: [1, "{{(Defender DA - Ação) Usado apenas em si mesmo.  Concede [[@{selected|da}]] de armadura.}}"],
            curar: [1, "{{(Curar - Ação) Usado apenas em si mesmo. Cura [[@{char|tvd}]] pontos de vida}}"],
            dadocurar: [1, "{{(Curar DA - Ação) Usado apenas em si mesmo. Cura [[@{char|da}]] pontos de vida}}"],
            empurrar: [1, "{{(Empurrar - Ação) Empurra o alvo em [[4]] casas}}"],
            puxar: [1, "{{(Puxar - Ação) Puxa o alvo em [[4]] casas}}"],
            reagir: [2, "{{(Reagir - Reação) Ao ser atacado, utilize uma reação.}}"],
            quebrar: [2, "{{(Quebrar - Ação) Diminui a duração OverSoul do alvo em [[2]]}}"],
            acrobacia: [2, "{{(Acrobacia - Reação) Não permite que usem reações}}"],

            cobra: [1, "{{(Cobra - Ação) Causa [[@{char|tat}]] de dano, puxa em [[4]] casas}}"],
            urso: [1, "{{(Urso - Ação) Usado apenas em si mesmo. Recupera [[4 + (@{char|vd} + @{char|eq_vd} + @{char|os_vd})]] pontos de vida}}"],
            lobo: [2, "{{(Lobo - Buff) Usado apenas em si mesmo. Presas dentro do seu alcance perdem [[2]] MV. Dura 3 turnos.}}"],
            aguia: [2, "{{(Águia - Ação) Movimenta [[@{char|tmv}]] casas levando um token adjacente com você.}}"],
            touro: [2, "{{(Touro - Ação) Causa [[(@{char|tat}) * 2]] de dano e empurra o alvo em [[6]] casas}}"],
            escorpiao: [2, "{{(Escorpião - Ação) Causa [[(@{char|tat}) * 2]] de dano e envenena o alvo. Ele perderá [[4]] PV por 2 turnos}}"],
            tartaruga: [2, "{{(Tartaruga - Reação) Uma reação que concede [[@{char|tdf}]] de armadura.}}"],

            fogo: [2, "{{(Fogo - Buff) Usado apenas em si mesmo. Alvos dentro do seu alcance perdem [[4]] PV. Dura 3 turnos}}"],
            gelo: [2, "{{(Gelo - Ação/Debuff) Causa [[(@{char|tat}) * 2]] de dano e congela o alvo. Seu MV será reduzido em [[2]] por 2 turnos}}"],
            madeira: [2, "{{(Madeira - Reação) Uma reação que impede que você seja puxado ou empurrado.}}"],
            raio: [2, "{{(Raio - Reação)Uma reação que permite você se movimentar [[4]] casas ao ser atacado.}}"],
            agua: [1, "{{(Água - Ação) Usado apenas em si mesmo. Diminui um contador de debuff em [[2]] turnos.}}"],
            vento: [1, "{{(Vento - Ação) Empurra um alvo em [[6]] casas sem restrição de direção. }}"],
            terra: [1, "{{(Pedra - Ação) Invoca [[2]] paredes de terra dentro do seu alcance. Elas se desfazem em [[1]] turno ou ao serem atacadas.}}"],

            gravidade: [1, "{{(Gravidade - Ação) Escolha entre puxar ou empurrar um alvo em [[4]] casas.}}"],
            trocar: [1, "{{(Trocar - Ação) Troque de posição com um aliado em seu alcance.}}"],
            tempo: [2, "{{(Parar - Buff) Usado apenas em si mesmo. Por [[2]] turnos, você não poderá receber nenhum debuff.}}"],
            magnetismo: [2, "{{(Magnetizar - Buff/Debuff) Magnetiza um alvo ou a si mesmo. Tokens no alcance serão puxados ou repelidos em [[4]] casas por [[4]] turnos (escolha)}}"],
            extender: [1, "{{(Extender - Ação) Aumenta o efeito de um contador em 2 turnos}}"],
            portal: [2, "{{(Portal - Ação) Se movimente para qualquer lugar do mapa.}}"],
            retroceder: [2, "{{(Afastar - Ação) Uma reação que empurra o alvo em [[4]] casas}}"],

            transferir: [1, "{{(Transferir - Ação) Transfere [[@{char|tvd}]] de PV para um aliado}}"],
            energia: [1, "{{(Conceder - Ação) Concede [[2]] de PO para um aliado}}"],
            converter: [1, "{{(Converter - Ação) Com OS desativado, converta [[6]] de PV para [[4]] PO }}"],
            regenerar: [2, "{{(Regenerar - Buff) Recupera [[@{char|tvd}]] PV a cada turno. Dura [[3]] turnos}}"],
            recuperar: [2, "{{(Recuperar - Ação) Anula [[1]] contador de debuff em qualquer aliado}}"],
            barreira: [2, "{{(Barreira - Reação) Anula danos em trocad e PO. Cada PO gasto anula 3 pontos de dano}}"],
            meditar: [2, "{{(Meditar - Buff) Com OS desativado, recupera [[3]] PO por turno. Dura [[3]] turnos}}"],

            corpo: [2, "{{(Esqueleto - Ação) Invoca um aliado com 3 MV, 1 AL, 6 PV e [[@{char|tat}]] AT.)}}"],
            resistencia: [1, "{{(Carcaça - Ação) Adiciona [[@{char|tvd}]] de PV a um esqueleto. }}"],
            dano: [1, "{{(Missão - Ação) Adiciona uma ação de ataque ao esqueleto}}"],
            area: [1, "{{(Sentido - Ação) Aumenta o MV de um esqueleto em [[1]]}}"],
            proteger: [1, "{{(Consciência - Ação) Adiciona uma ação de proteger ao esqueleto. Quando seu personagem for atacado, o esqueleto receberá o dano, se desejar. Esqueleto precisa estar em seu alcance.}}"],
            reintegrar: [2, "{{(Reintegrar - Reação) Quando um é derrotado, você ganha uma ação.}}"],
            combinar: [1, "{{(Combinar - Ação) Transfere as ações de um esqueleto para outro. Pode ser usado com reintegrar.}}"],

            liberar: [2, "{{(Liberar - Buff) Aumenta o ataque base de um alvo em [[2]]. Dura 3 turnos.)}}"],
            restringir: [2, "{{(Restringir - Debuff) Reduz o ataque base de um alvo em [[2]]. Dura 3 turnos}}"],
            voar: [2, "{{(Voar - Buff) O custo de alcance para acertarem seu personagem aumenta em [[2]]. Dura 3 turnos.)}}"],
            corrente: [2, "{{(Corrente - Ação) Causa [[@{char|tat}]] de dano em dois alvos diferentes ao seu alcance.}}"],
            defletir: [2, "{{(Defletir - Reação) Uma reação que causa um ataque de [[@{char|tat}]]. Você ainda receberá o dano normalmente. }}"],
            expandir: [2, "{{(Expandir - Buff) Aumenta o alcance base de um alvo em [[3]]. Dura 3 turnos. }}"],
            cegar: [2, "{{(Cegar - Debuff) Reduz o alcance base de um alvo em [[3]]. Dura 3 turnos. }}"],
            
        };

        function genAction(char, action, sync = false){
            let macro = typeof(actions[action]) !== 'undefined' ? actions[action][1].replace('}}','=[img]('+window.location.href+'img/'+action+'.png)}}') : '';
            let cost = typeof(actions[action]) !== 'undefined' ? actions[action][0] : '';

            macro = macro.replaceAll('char|','selected|');

            return [macro, cost];
        }

        function genMacro(char, skill_name = '?', all_actions = [] ){
            let macro = ['&{template:default} {{name='+char+' - '+skill_name+'}}'];
            let cost = 0;

            if (all_actions.length > 0){

                all_actions.forEach(function(action){
                    const sync = false;

                    let generated = genAction(char, action, sync);

                    if (generated[0]){
                        macro.push(generated[0]);
                        cost += generated[1];
                    }
                });
            }

            macro = macro.join(' ');

            if (jQuery('.skill-image').val().trim().length > 0){
                macro += "\n[img]("+jQuery('.skill-image').val().trim()+")";
            }

            return [macro, cost];
        }

        function renderSkill(){
            let skill_actions = [];

            jQuery('.skill-imgs-action').each(function(){
                skill_actions.push(jQuery(this).attr('data-action'));
            });

            const macro = genMacro(jQuery('.skill-char').val(), jQuery('.skill-name').val(), skill_actions);

            jQuery('.skill-macro').val(macro[0]);

            let custo_real = '?';

            switch (macro[1]){
                case 2: custo_real = 2; break;
                case 4: custo_real = 4; break;
                case 5: custo_real = 8; break;
                case 6: custo_real = 12; break;
                default: custo_real = '?';
            }

            jQuery('.skill-cost').text(custo_real + ' PO');
        }

        Object.keys(classes).forEach(function(key){
            classes[key].forEach(function(skill){
                jQuery('<button data-action="'+skill+'" data-cost="'+actions[skill][0]+'"><img src="./img/'+skill+'.png"></button>').appendTo('.skill-options.'+key);
            })
        });

        jQuery('.skill-options button').click(function(){
            jQuery('.skill-imgs').append(jQuery('<div class="skill-imgs-action" data-action="'+jQuery(this).attr('data-action')+'">'+jQuery(this).html()+'<button class="skill-remove">DEL</button></div>'));

            renderSkill();
        });

        jQuery(document).on('click', '.skill-remove', function(){
            jQuery(this).parent().remove();

            renderSkill();
        });

        jQuery('input').on('keyup', function(){
            renderSkill();
        });
    </script>
</body>
</html>